1.9	
	1.定时器(timer)
		
		(1)定义
					
			1.定时器与计数器。
				(1)计数器是用来技术的，每隔一个固定时间会计一个数。定时器的时间就是计数值×计数时间周期
				(2)定时器/计数器作为SoC内部外设，主要用来实现定时执行代码的功能。
				
		(2)作用
			1.让SoC在执行主程序的同时，可以(通过定时器)具有定时功能。到了一定时间(计时结束)后，定时器会产生中断提醒CPU，CPU会处理中断并执行定时器中的isr。
			
		(3)原理
			
			1.定时器计时其实是通过计数来实现的。定时器内部有一个计数器，这个计数器根据一个时钟(时钟源来自ARM的APB总线，然后经过时钟模块内部的分频器来分频得到)来工作。
			
			2.定时器内部有2个寄存器，先考虑其中一个TCNT。		
				例：把一个总的计数值(如300，自己设置)放入TCNT寄存器中，然后每隔一个时钟周期(如1ms，自己设置)TCNT中的值就会自动减1(硬件自动完成)，直到TCNT减为0的时候，TCNT就会触发定时器中断。
			
			3.定时器和看门狗、RTC、蜂鸣器的关系
				
				(1)看门狗其实就是一个定时器/计数器，但是定时时间到了之后不只是中断，还复位CPU。
			
				(2)RTC是实时时钟。
			
				(3)蜂鸣器是一个发声设备。
			
	2.S5PV210中的定时器
		
		(1)PWM定时器
			
			1.最常用定时器。一般SoC中产生PWM信号都是靠这个定时器模块的。
			
		(2)系统(操作系统)定时器
			1.用来产生固定时间间隔信号的(与TCNT有关)，这个信号称为systick，用来给操作系统提供tick信号。	
			
			2.产生systick作为操作系统的时间片(time slice)的。
			
		(3)看门狗定时器
			
			1.去上面2种定时器无本质区别。可以设置在时间到了的时候产生中断，也可以选择发出复位信号复位CPU。
			
		(4)实时时钟RTC(real time clock)
			
			1.区分时间段和时间点。时间段是相对的，两个时间点相减就会得到一个时间段。时间点是绝对的。
			
			2.定时器关注的是时间段(不是时间点)。RTC中工作用的是固定的时间点(年月日分秒)。
			
	3.S5PV210的PWM定时器1	
		
		(1)定义
			
			1.这种定时器天然是用来产生PWM波形的。
			
		(2)S5PV210中的PWM定时器
			
			1.S5PV210有5个PWM定时器。其中0、1、2、3各自对应一个外部GPIO，可以通过这些对应的GPIO产生PWM波形生成信号并输出。timer4没有对应的外部GPIO(因此不是为了生成PWM波形而是为了产生内部定时器中断而生的)。
			
			2.S5PV210中的5个PWM定时器地时钟源为PCLK_PSYS。timer0和timer1共同使用一个预分频器、timer2、3、4共同使用一个预分频器。每个timer都各自有一个专用的独立的分频器。
			
			预分频器和分频器构成了2级分频系统，将PCLK_PSYS两级分频后生成的时钟供给timer模块作为时钟周期。
			
		(3)S5PV210的PWM定时器框图 P794
			
			时钟源：PCLK_PSYS
			
			预分频器：8位预分频器(8BIT PRESCALERn)。分频系数是写入的数据+1。防止错写入了0，导致CPU损坏。
			
			分频器：1/1、1/2、1/4、1/8、1/16.多选1。			
			TCMPBn & TCNTB0：TCNTBn就是TCNT。TCMPBn
			
	4.S5PV210的PWM定时器2
		
		(1)预分频器和分频器
			
			1.两级分频是串联(级联)的，所以两级分频的分频数是相乘的。
			
			2.两级分频的分频系数分别在TCFG0和TCFG1两个寄存器设置。
			
			预分频器:TCFG0对应prescaler0，prescaler0为timer0、1共用；
					 TCFG1对应prescaler1，prescaler1为timer2、3、4共用。
					 两个prescaler都是8个bit位，所以 prescaler_value范围为0~255，预分频的分频值范围为2~256(最小写入1)。
			
			分频器：实质是一个MUX开关，多选一开关决定了走哪条分频系数路线(1/1、1/2、1/4、1/8、1/16)。
			
			分析：在PCLK_PSYS为66MHz(默认时钟设置)情况下，此时两级分频后的时钟范围为0.03us(33MHz,2分频)~62.061us(16.1KHz,256*16=4096分频)；在结合TCNTB的值(32位，0~2的32次方)的设置，可知能定的最长时间。
			
		(2)TCNT&TCMP、TCNTB&TCMPB、TCNTO		
			
			1.TCNTB是有地址的寄存器；TCNT在内部和TCNTB相对应，没有寄存器，程序员不能编程访问；TCNTO(Observation，观察)是给程序员用来读TCNT里的数。
			
			2.TCNTB负责接程序员丢的数，然后把数复制到TCNT(有一位寄存器专门操作)，让TCNT来减1；
			
			3.TCMPB用来生成PWM波，与定时功能无关。
			
		(3)自动重载和双缓冲(auto_reload and double buffering)
			
			1.定时器工作时，一次定时算一个工作循环：定时一次，计时一次，到期中断一次。下次还要再定时需要另外设置。反复重置太麻烦。
			
			2.高级SoC中的定时器已经默认内置了循环定时工作模式，就叫自动装载机制。一个周期到了后会自动从TCNTB再次把值装载到TCNT并再次启动定时器开始下个循环。
			
	5.S5PV210的PWM定时器3
		
		(1)PWM(pulse wide modulation 脉宽调制)
			
			1.PWM波形是一个周期性波形，周期为T，在每个周期内的波形是完全相同的。
			
			2.重要参数占空比duty，指一个周期内高电平的时间除以周期时间T的商。
			
			3.得到周期T和占空比duty，就可以算出这个波形的所有细节。如：高电平：T*duty；低电平：T*(1-duty)。
			
			4.PWM用处很多。如：通信上用PWM来进行脉宽调制对基波进行载波；在发光二极管LED照明领域可以用PWM波形来调制电流进行调光；驱动蜂鸣器设备。
			
		(2)PWM波形生成原理
			
			1.本质是用时间控制电平高低，所以要用定时器来实现PWM波形。
			
			2.现在设计SoC的时候已经直接把定时器和一个GPIO引脚内部绑定起来了，然后在定时器内部设置了PWM产生的机制，可以更方便的产生PWM波形，不用再中断进入isr了。
			
			3.PWM产生有两个关键寄存器：TCNTB、TCMPB。
		
				TCNTB：决定了PWM波形的周期。TCNTB*时钟周期(PCLK_PSYS经过两级分频后的时钟周期)就是最终生成的PWM波形周期。
				TCMPB：决定了PWM波形的占空比。TCMPB/TCNTB就是占空比。
			
				工作原理：TCMP的工作就是与TCNT的数相比。例：往TCNTB写入300，往TCMPB写入150。当300(在TCNT中)不断减一，就会不断与TCMP的数比较，大于等于150时，电平无变化，小于150时，电平变化(一次)，直到自动重载。
			
			4.输出电平翻转器
				
				(1)PWM定时器可以规定：当TCNT>TCMPB为高(低)电平；当TCNT<TCMPB时为低(高)电平。两种规定对于计算TCMP寄存器的值不同。

				(2)电平翻转器在电路上的实质是一个电平取反的不见可再编程上反应为一个寄存器位。写0关闭，写1开启。开启后和开启前输出电平刚好高低翻转(如果duty一开始是30%，就会变成70%)。

			5.死区生成器
				
				(1)PWM用一个应用是在功率电路中用来对交流电压进行整流。整流时2路整流分别在正电平和负电平时导通工作，不能同时导通(短路)。大功率的开关电源、逆变器等设备广泛使用了整流技术。其中逆变器是通过用SoC的GPIO输出的PWM波形来分别驱动2路整流的IGBT。

				(2)PWM波形用来做整流时不能同时高或低，但实际会有误差导致不能同时上升/下降沿，导致电路损坏，所以需要死区。	

				(3)死区少了容易短路。死区多了控制精度低了(不导通时间变长)，不利于产品性能提升。

				(4)S5PV210提供了死区生成器，开启后生产出来的PWM波形就自带了死区控制功能(非精确)。

















		