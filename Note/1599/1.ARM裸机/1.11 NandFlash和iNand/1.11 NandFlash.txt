1.11
	1.NandFlash的接口
		
		(1)Nand的型号与命名
			
			以三星的Nand名字为例：
			K9F：表示三星公司的NandFlash系列。
			2G ：表示Flash的大小。2Gbit，即256MB。
			08 ：表示Nand是8位的。
		
			所以根据Nand的名字可以看出：厂家、系列型号、容量大小、数据位数。
		
		(2)Nand的数据位
		
			1.Nand有8位数据位的，有16位数据位的。做电路/写软件时应根据自己实际采购的Nand位数来设计电路/写软件。
		
			2.以上说明Nand是并行接口的(8/16位)。
		
			3.Nand数据线上传递的不一定是有效数据，也可能有命令、地址等。
		
		(3)Nand的功能框图
			
			1.Nand的结构可以看成是一个矩阵式存储器，其中被分成一个一个的小块，每一个小块可以存储一个bit位，然后彼此以一定单位组合成整个Nand。
		
			2.Nand中够可以被单词访问的最小单元叫Page(页)。每次读写都至少以最小单元为单位。如以上所说的K9F2G08芯片中，Page的大小为2KB+64Bytes，这就是典型的块设备。现在有些块设备为了方便，提供了一种random read模式，可以只读1个字节。
		
			3.块(Block)，1个块等于若干个(整数个)页。在K9F2G08中，1个块等于64个页。
		
			4.整个Nand芯片叫做device，1个device等于若干个Block。如K9F2G08一个device有2048个block。可算出一个Device为256M。
			
			5.块设备因为物理上的限制，不能完全按字节访问，所以分成page(页)、block(块)。Page和Block各有各的意义。在Nand中Page是对Nand的最小单位；Block是擦除Nand的最小单位。这些规则都是Nand的物理原则和限制导致的，所以要去适应硬件。
		
			6.Nand芯片包含2部分：Nand存储颗粒+Nand接口电路
			
				Nand存储颗粒：就是纯粹的Nand原理的存储单元，类似于仓库。
				Nand接口电路：管理存储颗粒，并且给外界提供一个与Nand接口规格相同的访问接口。
		
			7.Nand中有多个存储单元，每个单元都有自己的地址(地址是精确到字节的)。但是实际读写只能精确到页。Nand读写时地址通常都要求页对齐。地址(30位)的传递是通过IO口发送的，但IO只有8位，所以需要多个cycle(一般4或5个)才能发送完毕。
		
			总结：SoC可以使用Nand接口时序来读写Nand存储芯片，理论上Nand接口是一种公用接口，外部SoC可以直接模拟Nand接口读写Nand芯片。但是实际上因为Nand接口对时序要求严格，所以一般的SoC都是通过专用的Nand控制器(一般作为内部外设)来操控Nand芯片。
		
	2.NandFlash的结构	
		
		(1)大页Nand与小页Nand
			
			1.Nand的页(Page)与块设备(硬盘)的扇区是类似的。扇区最早在磁盘中是512字节，后来的高级硬盘扇区变成1024字节/2048字节/4096字节。不用的Nand的页面大小也是不同的，也有512/1024/2048等不同的字节。
		
			2.不同的Nand一个块(block)等于多少页是不同的，一个Nand芯片有多少block也不一定。
			
			分析：因为Nand的组织结构混乱，接口时序页不同，造成不同厂家的不同系列型号存储容量的Nand接口也不一样。
		
		(2)带内数据和带外数据
			
			1.Nand的每个页(Page)由两部分组成，这2部分都有一定的存储空间。如K9F2G08中的Page为2KB+64Byte。
		
				2K字节属于带内数据，是真正的存储有效数据的空间。平时计算Nand容量也是只考虑这2K。
				64字节属于带外数据，不能用来存储有效数据。其用途有：存储ECC数据、存储坏块标志等。
		
				ECC数据：(error correction code,错误校验码)。因为Nand存储本身出错(位反转)概率高，稳定性差。所以存储有效信息到Nand时，会按照一定算法计算出一个ECC信息(如CRC16校验算法)存入当前页的带外数据区。将来读取数据时通过校验ECC来判断数据是否可信。
		
				坏块标志：Nand芯片用一段时间后，某些块会坏掉，即无法擦除或读写，这时无法避免的。在Nand的每个页的64字节的带外数据中，一般文件系统会定义一个固定位置(如24字节)来标记这个快是好还是坏。当文件系统发现块已没法用时，会标记对应块为坏块，往后访问Nand时会直接跳过坏块。
		
		(3)地址时序
			
			1.Nand的地址在写代码时要按照Nand要求的时序和顺序去依次写入。
				
		(4)Nand的命令码
			
			1.外部SoC通过Nand控制器(实质是通过Nand接口)来访问Nand，所以必须通过Nand接口给Nand发送命令、地址、数据等信息来读写Nand。
		
			2.对Nand进行的所有操作(操作、读、写)都要有命令、地址、数据的参与，而且要按照Nand芯片规定的流程来操作。
		
	3.NandFlash的常见操作及流程分析
		
		(1)坏块检查
			
			1.Flash使用之前要先统一擦除(擦除的单位是块)，擦除后里面全是1，所以擦除后读出来的值是0xff。
			
			2.检查坏块思路：先块擦除，然后将整块数据读出并依次检测各自环节是否为0xff。依次来判断是否坏块。
		
		(2)页写(program)操作
		
			1.写之前对应页要被擦除干净。
			
			2.SoC写Flash时通过命令线、IO线依次发送写命令、写页命令、写数据等到NandFlash。
		
			3.写的过程：SoC通过Nand控制器和Nand芯片完成顺序对接，然后按照时序要求将一页数据发给Nand芯片内部的接口电路。接口电路先接收数据到自己的缓冲区，然后再集中写入Nand芯片的存储区域中(写入的这段时间不能再相应SoC的命令)。
				SoC等待Nand的时候会通过不断读取状态寄存器，来确定Nand是否已完成命令。状态寄存器分2种情况：一种是SoC的Nand控制器自带，另一种是SoC通过发状态命令得到命令响应得到。
		
				如果SoC收到的状态不对，可以考虑重写或者认为当前页所在的块已经变坏块了，或整个Nand已经损坏。
		
			4.因为Nand的读写稳定性差，所以写完后会做ECC校验。ECC校验有硬件式校验和软件式校验2种。
		
				软件式校验：(手册推荐方式)读取刚写入的1页数据并将两者进行对比。
				
				硬件式校验：(当前普遍情况)SoC的Nand控制器可以提供硬件式校验。Nand的控制器中有个硬件模块专门做ECC操作。操作Nand芯片时，只要打开SoC的ECC生成开关，当我们写入数据时，ECC模块就会自动生成ECC数据放在相应寄存器中，这时只需将对应ECC数据写入Nand的带外数据区即可。
				
				在读过程中，ECC会自动计算读进的一页数据的ECC值，并将其放到相应寄存器中。将两边的ECC值进行校验，通过则说明读写正确。
		
		(3)擦除(erase)操作
			
			1.擦除时必须给块对齐的地址。如果地址不是块对齐，有些Nand芯片内部会自动将其对齐，有些Nand会返回地址错误。
		
			2.读写时给的地址也必须是页对齐。
		 
		(4)页读(read)操作
			
	4.S5PV210的Nand控制器
		
		(1)SoC的Nand控制器的作用
			
			因为Nand接口时序复杂，让SoC完全用软件来实现有一定难度。所以在SoC内部集成了一个Nand控制器。控制器实质是一块满足Nand接口时序操作的硬件电路，然后将接口时序的操作寄存器化。SoC只需编程操控Nand控制器的寄存器即可。
		
		拓展：现在几乎所有外设在SoC内部都有对应的控制器来与其通信，SoC内部集成的各种控制器越多，硬件能完成的功能也越多，对SoC软件编程也越简单。
		
		(2)结构框图
			
			关键点：
		
			SFR(special function register)：通过读写SFR来产生读写Nand接口时序，从而读写Nand芯片+Nand_interface(与Nand芯片引脚连接的硬件接口)+ECC生成器。
			
		(3)S5PV210Nand控制器的主要寄存器
			
			NFCONF、NFCONT、NFCMMD(命令)、NFADDR(地址)、NFDATA(读写数据)
			NFMECCDn(生成带内数据区的ECCD)、NFSECCD(生成带外数据区ECCD)
			NFSTAT(自带状态寄存器)
		
		